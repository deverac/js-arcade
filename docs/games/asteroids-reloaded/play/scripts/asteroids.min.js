var BITMAPS=!0,DEBUG=!1,GLOWEFFECT=!0,GLOWSHADOWBLUR=8,SCOREDBKEY="asteroids-score-1.1",g_asteroidImgs=[];g_asteroidImgs[0]=new Image,g_asteroidImgs[1]=new Image,g_asteroidImgs[2]=new Image,g_asteroidImgs[3]=new Image;var g_shieldImg=new Image,g_backgroundImg=new Image,g_playerImg=new Image,g_enemyshipImg=new Image,Asteroids;function onloadHandler(){var e,t="en";-1===(e=window.location.search.indexOf("locale="))||0!==(e=window.location.search.substring(e+7).split("&")).length&&(t=e[0]),Game.Util.loadMessages(t),g_backgroundImg.src="images/bg3_1.jpg",g_backgroundImg.onload=function(){GameHandler.init(),GameHandler.audioContext&&(GameHandler.loadSound("sounds/laser.mp3","laser"),GameHandler.loadSound("sounds/enemybomb.mp3","enemy_bomb"),GameHandler.loadSound("sounds/bigboom.mp3","big_boom"),GameHandler.loadSound("sounds/explosion1.mp3","asteroid_boom1"),GameHandler.loadSound("sounds/explosion2.mp3","asteroid_boom2"),GameHandler.loadSound("sounds/explosion3.mp3","asteroid_boom3"),GameHandler.loadSound("sounds/explosion4.mp3","asteroid_boom4"),GameHandler.loadSound("sounds/powerup.mp3","powerup")),GameHandler.start(new Asteroids.Main)}}function AsteroidsParticle(e,t,s,i,r,a,n){this.particleStart=GameHandler.frameStart,this.position=e,this.vector=t,this.size=s,this.type=i,this.lifespan=r,this.fadelength=a,this.colour=n||Asteroids.Colours.PARTICLE,1===i&&(this.rotate=Rnd()*TWOPI,this.rotationv=.5*(Rnd()-.5)),this.fadeValue=function(e,t){var s=this.lifespan-(GameHandler.frameStart-this.particleStart),i=e;return s<t&&((i=e/t*s)<0?i=0:e<i&&(i=e)),i},this.update=function(){return this.position.add(this.vector),!(GameHandler.frameStart-this.particleStart>this.lifespan)},this.render=function(e){switch(e.globalAlpha=this.fadeValue(1,this.fadelength),this.type){case 0:e.translate(this.position.x,this.position.y),e.drawImage(GameHandler.bitmaps.images["points_"+this.colour][this.size],0,0);break;case 1:e.translate(this.position.x,this.position.y);var t=this.size;e.rotate(this.rotate),this.rotate+=this.rotationv,e.strokeStyle=this.colour,e.lineWidth=1.5,e.beginPath(),e.moveTo(-t,-t),e.lineTo(t,t),e.closePath(),e.stroke();break;case 2:t=this.size+1<<2;Game.Util.renderImage(e,GameHandler.bitmaps.images["smudges_"+this.colour][this.size],0,0,this.size+1<<3,this.position.x-t,this.position.y-t,this.size+1<<3)}}}window.addEventListener("load",onloadHandler,!1),void 0!==Asteroids&&Asteroids||(Asteroids={}),Asteroids.Colours={PARTICLE:"rgb(255,125,50)",ENEMY_SHIP:"rgb(200,200,250)",ENEMY_SHIP_DARK:"rgb(150,150,200)",GREEN_LASER:"rgb(120,255,120)",GREEN_LASER_DARK:"rgb(50,255,50)",GREEN_LASERX2:"rgb(120,255,150)",GREEN_LASERX2_DARK:"rgb(50,255,75)",PLAYER_BOMB:"rgb(155,255,155)",PLAYER_THRUST:"rgb(25,125,255)",PLAYER_SHIELD:"rgb(100,100,255)"},Asteroids.Main=function(){Asteroids.Main.superclass.constructor.call(this);var e=new Asteroids.AttractorScene(this),t=new Game.Preloader;t.addImage(g_playerImg,"images/player.png"),t.addImage(g_asteroidImgs[0],"images/asteroid1.png"),t.addImage(g_asteroidImgs[1],"images/asteroid2.png"),t.addImage(g_asteroidImgs[2],"images/asteroid3.png"),t.addImage(g_asteroidImgs[3],"images/asteroid4.png"),t.addImage(g_shieldImg,"images/shield.png"),t.addImage(g_enemyshipImg,"images/enemyship1.png"),t.onLoadCallback(function(){e.ready()}),this.player=new Asteroids.Player(new Vector(GameHandler.width/2,GameHandler.height/2),new Vector(0,0),0),this.scenes.push(e);for(var s,i=0;i<12;i++)s=new Asteroids.GameScene(this,i+1),this.scenes.push(s);this.scenes.push(new Asteroids.GameCompleted(this)),this.endScene=new Asteroids.GameOverScene(this);for(var r,i=0;i<this.STARFIELD_SIZE;i++)(r=new Asteroids.Star).init(),this.starfield.push(r);!localStorage||(t=localStorage.getItem(SCOREDBKEY))&&(this.highscore=t),GameHandler.bitmaps=new Asteroids.Prerenderer,GameHandler.bitmaps.execute()},extend(Asteroids.Main,Game.Main,{STARFIELD_SIZE:64,player:null,lives:0,score:0,highscore:0,backgroundX:0,starfield:[],onRenderGame:function(e){!BITMAPS||DEBUG&&DEBUG.NOBACKGROUND?(e.shadowBlur=0,e.clearRect(0,0,GameHandler.width,GameHandler.height),DEBUG&&DEBUG.NOBACKGROUND||this.updateStarfield(e),e.shadowBlur=GLOWEFFECT?GLOWSHADOWBLUR:0,e.lineWidth=1.5):(e.drawImage(g_backgroundImg,this.backgroundX,0,GameHandler.width,GameHandler.height,0,0,GameHandler.width,GameHandler.height),this.backgroundX+=.25*GameHandler.frameMultipler,this.backgroundX>=.5*g_backgroundImg.width&&(this.backgroundX-=.5*g_backgroundImg.width),e.shadowBlur=0)},isGameOver:function(){return 0===this.lives&&this.currentScene.effects&&0===this.currentScene.effects.length},updateStarfield:function(e){e.save(),e.strokeStyle="rgb(200,200,200)";for(var t,s=0,i=this.starfield.length;s<i;s++)(t=this.starfield[s]).render(e),t.z-=t.VELOCITY*GameHandler.frameMultipler*.1,(t.z<.1||t.prevx>GameHandler.height||t.prevy>GameHandler.width)&&t.init();e.restore()},updateActorPosition:function(e){e.position.add(e.vector.nscale(GameHandler.frameMultipler)),e.position.x>=GameHandler.width?e.position.x=0:e.position.x<0&&(e.position.x=GameHandler.width-1),e.position.y>=GameHandler.height?e.position.y=0:e.position.y<0&&(e.position.y=GameHandler.height-1)}}),Asteroids.AttractorScene=function(e){this.game=e;var t=this;GameHandler.canvas.addEventListener("mousedown",function(e){if(0===e.button&&t.imagesLoaded)return t.start=!0},!1),Asteroids.AttractorScene.superclass.constructor.call(this,!1,null)},extend(Asteroids.AttractorScene,Game.Scene,{game:null,start:!1,imagesLoaded:!1,sine:0,mult:0,multIncrement:0,actors:null,SCENE_LENGTH:400,SCENE_FADE:75,sceneRenderers:null,currentSceneRenderer:0,currentSceneFrame:0,isComplete:function(){return this.start},onInitScene:function(){this.start=!1,this.mult=512,this.multIncrement=.5,this.currentSceneRenderer=0,this.currentSceneFrame=0,this.sceneRenderers=[],this.sceneRenderers.push(this.sceneRendererWelcome),this.sceneRenderers.push(this.sceneRendererScores),this.actors=[];for(var e=0;e<8;e++){var t=new Vector(Rnd()*GameHandler.width,Rnd()*GameHandler.height),s=new Vector(2*Rnd()-1,2*Rnd()-1);this.actors.push(new Asteroids.Asteroid(t,s,randomInt(3,4)))}this.game.score=0,this.game.lives=3},onRenderScene:function(e){if(this.imagesLoaded){for(var t=0,s=this.actors.length;t<s;t++){var i=this.actors[t];i.onUpdate(this),this.game.updateActorPosition(i),i.onRender(e)}++this.currentSceneFrame===this.SCENE_LENGTH&&(++this.currentSceneRenderer===this.sceneRenderers.length&&(this.currentSceneRenderer=0),this.currentSceneFrame=0),e.save(),this.currentSceneFrame<this.SCENE_FADE?e.globalAlpha=1-(this.SCENE_FADE-this.currentSceneFrame)/this.SCENE_FADE:this.currentSceneFrame>=this.SCENE_LENGTH-this.SCENE_FADE&&(e.globalAlpha=(this.SCENE_LENGTH-this.currentSceneFrame)/this.SCENE_FADE),this.sceneRenderers[this.currentSceneRenderer].call(this,e),e.restore(),this.sineText(e,Game.Util.message("title"),.5*GameHandler.width-130,.5*GameHandler.height-64)}else(BITMAPS?Game.centerFillText:Game.centerDrawText)(e,Game.Util.message("please-wait"),"18pt Arial",.5*GameHandler.height,"white")},sceneRendererWelcome:function(e){e.fillStyle=e.strokeStyle="white",(BITMAPS?Game.centerFillText:Game.centerDrawText)(e,iOS?"Touch to start!":Game.Util.message("start"),"18pt Arial",.5*GameHandler.height)},sceneRendererInfo:function(e){e.fillStyle=e.strokeStyle="white";var t=BITMAPS?Game.fillText:Game.drawText;iOS?(t(e,Game.Util.message("instruction1"),"14pt Arial",40,320),t(e,"Touch in the left hand side of the screen and drag left/right to rotate.","14pt Arial",40,350),t(e,"Touch in the right hand side of the screen and drag up to thrust","14pt Arial",40,370),t(e,"and flick down for shield.","14pt Arial",40,390),t(e,Game.Util.message("instruction3"),"14pt Arial",40,410),t(e,Game.Util.message("instruction4"),"14pt Arial",40,430)):(t(e,Game.Util.message("instruction1"),"14pt Arial",40,320),t(e,Game.Util.message("instruction2"),"14pt Arial",40,350),t(e,Game.Util.message("instruction3"),"14pt Arial",40,370),t(e,Game.Util.message("instruction4"),"14pt Arial",40,390),t(e,Game.Util.message("instruction5"),"14pt Arial",40,410),t(e,Game.Util.message("instruction6"),"14pt Arial",40,430))},sceneRendererScores:function(e){e.fillStyle=e.strokeStyle="white";var t=BITMAPS?Game.centerFillText:Game.centerDrawText;t(e,Game.Util.message("high-score"),"18pt Courier New",320);for(var s=this.game.highscore.toString(),i=0,r=8-s.length;i<r;i++)s="0"+s;t(e,s,"18pt Courier New",350)},ready:function(){this.imagesLoaded=!0},sineText:function(e,t,s,i){this.mult+=this.multIncrement,(1024<this.mult||this.mult<128)&&(this.multIncrement=-this.multIncrement);for(var r=this.sine,a=0,n=t.length;a<n;a++){var o=i+Sin(r)*RAD*this.mult,l=s+Cos(r++)*RAD*(.5*this.mult);(BITMAPS?Game.fillText:Game.drawText)(e,t[a],"36pt Courier New",l+30*a,o,"white")}this.sine+=.075},onKeyDownHandler:function(e){switch(e){case GameHandler.GAMEPAD+0:case GameHandler.GAMEPAD+7:case GameHandler.KEY.SPACE:return this.imagesLoaded&&(this.start=!0),!0;case GameHandler.KEY.R:return BITMAPS=!BITMAPS,!0;case GameHandler.KEY.S:return GameHandler.soundEnabled=!GameHandler.soundEnabled,!0;case GameHandler.KEY.ESC:return GameHandler.pause(),!0}}}),Asteroids.GameOverScene=function(e){this.game=e,this.player=e.player;e=new Game.Interval(Game.Util.message("game-over"),this.intervalRenderer);Asteroids.GameOverScene.superclass.constructor.call(this,!1,e)},extend(Asteroids.GameOverScene,Game.Scene,{game:null,isComplete:function(){return!0},intervalRenderer:function(e,t){if(0==e.framecounter++&&this.game.score===this.game.highscore){localStorage&&localStorage.setItem(SCOREDBKEY,this.game.score);try{var s,i;$&&(s=this.game.score,$("#results").html(Game.Util.message("new-high-score")+": "+s),i="http://twitter.com/home/?status=I%20scored:%20"+s+"%20-%20in%20the%20Asteroids%20[Reloaded]%20HTML5%20game!%20Try%20your%20skillz...%20http://bit.ly/asteroids%20%23javascript%20%23html5",$("#tweetlink").attr("href",i),$("#results-wrapper").fadeIn())}catch(e){}}e.framecounter<300?(Game.fillText(t,e.label,"18pt Courier New",.5*GameHandler.width-64,.5*GameHandler.height-32,"white"),Game.fillText(t,Game.Util.message("score")+": "+this.game.score,"14pt Courier New",.5*GameHandler.width-64,.5*GameHandler.height,"white"),this.game.score===this.game.highscore&&Game.fillText(t,Game.Util.message("new-high-score")+"!","14pt Courier New",.5*GameHandler.width-64,.5*GameHandler.height+24,"white")):e.complete=!0}}),Asteroids.GameCompleted=function(e){this.game=e,this.player=e.player;e=new Game.Interval(Game.Util.message("congratulations"),this.intervalRenderer);Asteroids.GameCompleted.superclass.constructor.call(this,!1,e)},extend(Asteroids.GameCompleted,Game.Scene,{game:null,isComplete:function(){return!0},intervalRenderer:function(e,t){0==e.framecounter++&&this.game.score===this.game.highscore&&localStorage&&localStorage.setItem(SCOREDBKEY,this.game.score),e.framecounter<1e3?(Game.fillText(t,e.label,"18pt Courier New",.5*GameHandler.width-96,.5*GameHandler.height-32,"white"),Game.fillText(t,Game.Util.message("score")+": "+this.game.score,"14pt Courier New",.5*GameHandler.width-64,.5*GameHandler.height,"white"),this.game.score===this.game.highscore&&Game.fillText(t,Game.Util.message("new-high-score")+"!","14pt Courier New",.5*GameHandler.width-64,.5*GameHandler.height+24,"white")):e.complete=!0}}),function(){Asteroids.GameScene=function(e,t){this.game=e,this.wave=t,this.player=e.player;t=new Game.Interval(Game.Util.message("wave")+" "+t,this.intervalRenderer);Asteroids.GameScene.superclass.constructor.call(this,!0,t)},extend(Asteroids.GameScene,Game.Scene,{game:null,wave:0,input:{left:!1,right:!1,thrust:!1,shield:!1,fireA:!1,fireB:!1},player:null,actors:null,playerBullets:null,enemies:null,enemyBullets:null,effects:null,collectables:null,enemyShipCount:0,enemyShipAdded:0,scoredisplay:0,skipLevel:!1,onInitScene:function(){this.actors=[],this.enemies=[],this.actors.push(this.enemies),this.actors.push(this.playerBullets=[]),this.actors.push(this.enemyBullets=[]),this.actors.push(this.effects=[]),this.actors.push(this.collectables=[]),this.resetPlayerActor(1!==this.wave);for(var e=1+.075*(this.wave-1),t=1,s=4+this.wave;t<s;t++)this.enemies.push(this.generateAsteroid(e));this.enemyShipAdded=GameHandler.frameStart,this.enemyShipCount=0,this.interval.reset(),this.skipLevel=!1},resetPlayerActor:function resetPlayerActor(persistPowerUps){with(this.actors.push([this.player]),this.player)position.x=GameHandler.width/2,position.y=GameHandler.height/2,vector.x=0,vector.y=0,heading=0,reset(persistPowerUps);with(this.input)left=!1,right=!1,thrust=!1,shield=!1,fireA=!1,fireB=!1},onBeforeRenderScene:function(){this.input.left&&(this.player.heading-=4*GameHandler.frameMultipler),this.input.right&&(this.player.heading+=4*GameHandler.frameMultipler),this.input.thrust?this.player.thrust():iOS&&this.player.vector.scale(.985),this.input.shield&&(this.player.expired()||this.player.activateShield()),(this.input.fireA||iOS||DEBUG&&DEBUG.AUTOFIRE)&&this.player.firePrimary(this.playerBullets),this.input.fireB&&this.player.fireSecondary(this.playerBullets),this.enemyShipCount<=(this.wave<5?0:1)&&GameHandler.frameStart-this.enemyShipAdded>2e4-1024*this.wave&&(this.enemies.push(new Asteroids.EnemyShip(this,this.wave<3?0:randomInt(0,1))),this.enemyShipCount++,this.enemyShipAdded=GameHandler.frameStart),this.updateActors()},onRenderScene:function(e){if(this.renderActors(e),DEBUG&&DEBUG.COLLISIONRADIUS&&this.renderCollisionRadius(e),this.renderOverlay(e),this.collisionDetectBullets(),this.player.expired()){if(3e3<GameHandler.frameStart-this.player.killedOn){for(var t=!1,s=new Vector(.5*GameHandler.width,.5*GameHandler.height),i=0,r=this.enemies.length;i<r;i++){var a=this.enemies[i];if(s.distance(a.position)<80){t=!0;break}}!1===t&&this.resetPlayerActor()}}else this.collisionDetectPlayer()},isComplete:function(){return this.skipLevel||0===this.enemies.length&&0===this.effects.length},intervalRenderer:function(e,t){e.framecounter++<100?(BITMAPS?Game.fillText:Game.drawText)(t,e.label,"18pt Courier New",.5*GameHandler.width-48,.5*GameHandler.height-8,"white"):e.complete=!0},onKeyDownHandler:function(e){switch(e){case GameHandler.KEY.LEFT:return this.input.left=!0;case GameHandler.KEY.RIGHT:return this.input.right=!0;case GameHandler.KEY.UP:case GameHandler.GAMEPAD+2:return this.input.thrust=!0;case GameHandler.KEY.DOWN:case GameHandler.KEY.SHIFT:case GameHandler.GAMEPAD+1:return this.input.shield=!0;case GameHandler.KEY.SPACE:case GameHandler.GAMEPAD+0:case GameHandler.GAMEPAD+7:return this.input.fireA=!0;case GameHandler.KEY.Z:case GameHandler.GAMEPAD+3:return this.input.fireB=!0;case GameHandler.KEY.R:return BITMAPS=!BITMAPS,!0;case GameHandler.KEY.S:return GameHandler.soundEnabled=!GameHandler.soundEnabled,!0;case GameHandler.KEY.A:if(DEBUG)return this.enemies.push(this.generateAsteroid(1)),!0;break;case GameHandler.KEY.G:if(DEBUG)return GLOWEFFECT=!GLOWEFFECT,!0;break;case GameHandler.KEY.L:if(DEBUG)return this.skipLevel=!0;break;case GameHandler.KEY.E:if(DEBUG)return this.enemies.push(new Asteroids.EnemyShip(this,randomInt(0,1))),!0;break;case GameHandler.KEY.ESC:return GameHandler.pause(),!0}},onKeyUpHandler:function(e){switch(e){case GameHandler.KEY.LEFT:return!(this.input.left=!1);case GameHandler.KEY.RIGHT:return!(this.input.right=!1);case GameHandler.KEY.UP:case GameHandler.GAMEPAD+2:return!(this.input.thrust=!1);case GameHandler.KEY.DOWN:case GameHandler.KEY.SHIFT:case GameHandler.GAMEPAD+1:return!(this.input.shield=!1);case GameHandler.KEY.SPACE:case GameHandler.GAMEPAD+0:case GameHandler.GAMEPAD+7:return!(this.input.fireA=!1);case GameHandler.KEY.Z:case GameHandler.GAMEPAD+3:return!(this.input.fireB=!1)}},onAxisHandler:function(e,t){if(0===e)switch(Math.round(t)){case 0:this.input.left=this.input.right=!1;break;case 1:this.input.right=!0;break;case-1:this.input.left=!0}},touches:[],onTouchStartHandler:function(e){for(var t,s=0;s<e.changedTouches.length;s++)t=e.changedTouches[s],this.touches[t.identifier]={tx:t.screenX,ty:t.screenY,txd:t.screenX,tyd:t.screenY};return!0},onTouchMoveHandler:function(e){for(var t,s=0;s<e.changedTouches.length;s++)t=e.changedTouches[s],this.touches[t.identifier].tx=t.screenX,this.touches[t.identifier].ty=t.screenY;for(s in this.touches)this.touches[s].tx<.5*window.innerWidth?this.player.heading-=(this.touches[s].txd-this.touches[s].tx)*GameHandler.frameMultipler:this.touches[s].ty<this.touches[s].tyd?this.player.thrust():this.touches[s].ty-16>this.touches[s].tyd&&this.player.activateShield(),this.touches[s].txd=this.touches[s].tx,this.touches[s].tyd=this.touches[s].ty;return!0},onTouchEndHandler:function(e){for(var t,s=0;s<e.changedTouches.length;s++)t=e.changedTouches[s],delete this.touches[t.identifier];return!0},generateAsteroid:function(e){for(;;){var t=new Vector(Rnd()*GameHandler.width,Rnd()*GameHandler.height);if(125<this.player.position.distance(t)){var s=new Vector((2*Rnd()-1)*e,(2*Rnd()-1)*e);return new Asteroids.Asteroid(t,s,4)}}},updateActors:function(){for(var e=0,t=this.actors.length;e<t;e++)for(var s=this.actors[e],i=0;i<s.length;i++){var r=s[i];r.onUpdate(this),r.expired()?s.splice(i,1):this.game.updateActorPosition(r)}},destroyPlayer:function(){this.player.kill(),this.game.lives--;var e=new Asteroids.PlayerExplosion(this.player.position.clone(),this.player.vector.clone());this.effects.push(e),GameHandler.playSound("big_boom")},collisionDetectPlayer:function(){for(var e=this.player.radius(),t=this.player.position,s=0,i=this.enemies.length;s<i;s++){var r=this.enemies[s];t.distance(r.position)<=e+r.radius()&&(this.player.isShieldActive()?(this.player.vector.scale(.75),r.hit(-1),this.destroyEnemy(r,this.player.vector,!0)):DEBUG&&DEBUG.INVINCIBLE||this.destroyPlayer())}for(var a=0;a<this.enemyBullets.length;a++){var n=this.enemyBullets[a];t.distance(n.position)<=e+n.radius()&&(this.player.isShieldActive()?this.enemyBullets.splice(a,1):DEBUG&&DEBUG.INVINCIBLE||this.destroyPlayer())}for(a=0;a<this.collectables.length;a++){var o=this.collectables[a];t.distance(o.position)<=e+o.radius()&&(this.collectables.splice(a,1),o.collected(this.game,this.player,this),GameHandler.playSound("powerup"))}},collisionDetectBullets:function(){for(var e=0;e<this.playerBullets.length;e++){var t=(u=this.playerBullets[e]).radius(),s=u.position;for(d=0,c=this.enemies.length;d<c;d++)if(p=this.enemies[d],s.distance(p.position)<=t+p.radius()){var i=u.effectRadius();if(0===i)p.hit(u.power())?(this.destroyEnemy(p,u.vector,!0),this.generatePowerUp(p)):(m=new Asteroids.PlayerBulletImpact(u.position,u.vector),this.effects.push(m));else{p.hit(-1),this.generatePowerUp(p);var r=1,a=new Asteroids.Explosion(u.position.clone(),u.vector.nscale(.5),5);this.effects.push(a),this.destroyEnemy(p,u.vector,!0);for(var n,o,l=0,h=this.enemies.length;l<h;l++)n=this.enemies[l],s.distance(n.position)<=i+n.radius()&&(n.hit(-1),this.generatePowerUp(n),this.destroyEnemy(n,u.vector,!0),r++);4<r&&(o=1e3*r*this.wave,this.game.score+=o,a=new Vector(0,-3),m=new Asteroids.ScoreIndicator(new Vector(p.position.x,p.position.y-8*p.size),a.add(p.vector.nscale(.5)),o,16,Game.Util.message("hit-combo")+" X"+r,"rgb(255,255,55)",1e3),this.effects.push(m),this.generatePowerUp(p,!0))}this.playerBullets.splice(e,1);break}}for(var d,c,e=0;e<this.enemyBullets.length;e++){var u,t=(u=this.enemyBullets[e]).radius(),s=u.position;for(d=0,c=this.enemies.length;d<c;d++){var m,p=this.enemies[d];if(p instanceof Asteroids.Asteroid&&s.distance(p.position)<=t+p.radius()){p.hit(1)?this.destroyEnemy(p,u.vector,!1):(m=new Asteroids.EnemyBulletImpact(u.position,u.vector),this.effects.push(m)),this.enemyBullets.splice(e,1);break}}}},generatePowerUp:function(e,t){var s;this.collectables.length<5&&(t||0===randomInt(0,e instanceof Asteroids.Asteroid?25:1))&&(s=e.vector.clone(),(t=new Vector(0,-2*Rnd())).rotate(e.vector.theta()*(Rnd()*PI)),s.add(t),this.collectables.push(new Asteroids.PowerUp(new Vector(e.position.x,e.position.y-8*e.size),s)))},destroyEnemy:function(e,t,s){var i,r,a,n;e instanceof Asteroids.Asteroid?(GameHandler.playSound("asteroid_boom"+randomInt(1,4)),this.generateBabyAsteroids(e,t),i=new Asteroids.AsteroidExplosion(e.position.clone(),e.vector.clone(),e),this.effects.push(i),s&&(r=4*(5-e.size)*100*this.wave,this.game.score+=r,a=new Vector(0,-1.5).add(e.vector.nscale(.5)),n=new Asteroids.ScoreIndicator(new Vector(e.position.x,e.position.y-8*e.size),a,r),this.effects.push(n))):e instanceof Asteroids.EnemyShip&&(GameHandler.playSound("asteroid_boom1"),i=new Asteroids.EnemyExplosion(e.position.clone(),e.vector.clone(),e),this.effects.push(i),s&&(r=2e3*this.wave*(e.size+1),this.game.score+=r,a=new Vector(0,-1.5).add(e.vector.nscale(.5)),n=new Asteroids.ScoreIndicator(new Vector(e.position.x,e.position.y-16),a,r),this.effects.push(n)),this.enemyShipCount--)},generateBabyAsteroids:function(e,t){if(1<e.size)for(var s=0,i=randomInt(e.size/2,e.size-1);s<i;s++){var r=randomInt(1,e.size-1),a=e.vector.clone(),n=new Vector(0,-Rnd());n.rotate(e.vector.theta()*(Rnd()*PI)),a.add(n),a.add(t.nscale(.2));r=new Asteroids.Asteroid(new Vector(e.position.x+5*Rnd()-2.5,e.position.y+5*Rnd()-2.5),a,r,e.type);this.enemies.push(r)}},renderActors:function(e){for(var t=0,s=this.actors.length;t<s;t++)for(var i=this.actors[t],r=i.length-1;0<=r;r--)i[r].onRender(e)},renderCollisionRadius:function(e){e.save(),e.strokeStyle="rgb(255,0,0)",e.lineWidth=.5;for(var t=e.shadowBlur=0,s=this.actors.length;t<s;t++)for(var i,r=this.actors[t],a=r.length-1;0<=a;a--)(i=r[a]).radius&&(e.beginPath(),e.arc(i.position.x,i.position.y,i.radius(),0,TWOPI,!0),e.closePath(),e.stroke());e.restore()},renderOverlay:function(e){e.save(),e.shadowBlur=0,e.strokeStyle="rgb(50,50,255)",e.strokeRect(4,4,101,6),e.fillStyle="rgb(100,100,255)";var t=this.player.energy;t>this.player.ENERGY_INIT&&(t=this.player.ENERGY_INIT),e.fillRect(5,5,t/(this.player.ENERGY_INIT/100),5);for(var s=0;s<this.game.lives;s++)BITMAPS?e.drawImage(g_playerImg,0,0,64,64,380+20*s,0,16,16):(e.save(),e.strokeStyle="white",e.translate(380+16*s,8),e.beginPath(),e.moveTo(-4,6),e.lineTo(4,6),e.lineTo(0,-6),e.closePath(),e.stroke(),e.restore());var i=this.game.score,t=(i-this.scoredisplay)/10;this.scoredisplay+=t,this.scoredisplay>i&&(this.scoredisplay=i);for(var r=Ceil(this.scoredisplay).toString(),s=0,a=8-r.length;s<a;s++)r="0"+r;Game.fillText(e,r,"12pt Courier New",120,12,"white"),i>this.game.highscore&&(this.game.highscore=i);for(s=0,a=8-(r=this.game.highscore.toString()).length;s<a;s++)r="0"+r;Game.fillText(e,Game.Util.message("hi-score")+": "+r,"12pt Courier New",220,12,"white"),DEBUG&&DEBUG.FPS&&Game.fillText(e,"FPS: "+GameHandler.maxfps,"12pt Courier New",0,GameHandler.height-2,"lightblue"),e.restore()}})}(),Asteroids.Star=function(){return this},Asteroids.Star.prototype={MAXZ:12,VELOCITY:.85,x:0,y:0,z:0,prevx:0,prevy:0,init:function(){this.prevx=this.prevy=0,this.x=(Rnd()*GameHandler.width-.5*GameHandler.width)*this.MAXZ,this.y=(Rnd()*GameHandler.height-.5*GameHandler.height)*this.MAXZ,this.z=this.MAXZ},render:function(e){var t=this.x/this.z,s=this.y/this.z;this.prevx&&(e.lineWidth=1/this.z*5+1,e.beginPath(),e.moveTo(this.prevx+.5*GameHandler.width,this.prevy+.5*GameHandler.height),e.lineTo(t+.5*GameHandler.width,s+.5*GameHandler.height),e.stroke()),this.prevx=t,this.prevy=s}},Asteroids.Player=function(e,t,s){return Asteroids.Player.superclass.constructor.call(this,e,t),this.heading=s,this.energy=this.ENERGY_INIT,this.animImage=g_shieldImg,this.animLength=this.SHIELD_ANIM_LENGTH,this.primaryWeapons=[],this},extend(Asteroids.Player,Game.SpriteActor,{MAX_PLAYER_VELOCITY:8,PLAYER_RADIUS:9,SHIELD_RADIUS:14,SHIELD_ANIM_LENGTH:100,SHIELD_MIN_PULSE:20,ENERGY_INIT:400,THRUST_DELAY_MS:100,BOMB_RECHARGE_MS:800,BOMB_ENERGY:80,heading:0,energy:0,shieldCounter:0,alive:!0,primaryWeapons:null,bombRecharge:0,thrustRecharge:0,engineThrust:!1,killedOn:0,fireWhenShield:!1,onRender:function(e){var t,s,i=this.heading*RAD;this.engineThrust&&(e.save(),e.translate(this.position.x,this.position.y),e.rotate(i),e.globalAlpha=.5+.5*Rnd(),BITMAPS?(e.globalCompositeOperation="lighter",e.fillStyle=Asteroids.Colours.PLAYER_THRUST):e.shadowColor=e.strokeStyle=Asteroids.Colours.PLAYER_THRUST,e.beginPath(),e.moveTo(-5,8),e.lineTo(5,8),e.lineTo(0,18+6*Rnd()),e.closePath(),BITMAPS?e.fill():e.stroke(),e.restore(),this.engineThrust=!1),BITMAPS?(t=2*this.PLAYER_RADIUS+6,(s=Floor(this.heading)%360)<0&&(s=360+s),e.save(),e.drawImage(g_playerImg,0,64*Floor(s/4),64,64,this.position.x-t/2,this.position.y-t/2,t,t)):(e.save(),e.shadowColor=e.strokeStyle="#fff",e.translate(this.position.x,this.position.y),e.rotate(i),e.beginPath(),e.moveTo(-6,8),e.lineTo(6,8),e.lineTo(0,-8),e.closePath(),e.stroke()),e.restore(),0<this.shieldCounter&&0<this.energy&&(BITMAPS?(e.save(),e.translate(this.position.x,this.position.y),e.rotate(i),this.renderSprite(e,-this.SHIELD_RADIUS-1,-this.SHIELD_RADIUS-1,2*this.SHIELD_RADIUS+2)):(e.save(),e.translate(this.position.x,this.position.y),e.rotate(i),e.shadowColor=e.strokeStyle=Asteroids.Colours.PLAYER_SHIELD,e.beginPath(),e.arc(0,2,this.SHIELD_RADIUS,0,TWOPI,!0),e.closePath(),e.stroke()),e.restore(),this.shieldCounter--,this.energy-=1.5)},thrust:function(){var e;GameHandler.frameStart-this.thrustRecharge>this.THRUST_DELAY_MS&&(this.thrustRecharge=GameHandler.frameStart,(e=new Vector(0,iOS?-1.25:-.5)).rotate(this.heading*RAD),this.vector.add(e),this.vector.length()>this.MAX_PLAYER_VELOCITY&&this.vector.scale(this.MAX_PLAYER_VELOCITY/this.vector.length())),this.engineThrust=!0},activateShield:function(){this.energy>=this.SHIELD_MIN_PULSE&&(this.shieldCounter=this.SHIELD_MIN_PULSE)},isShieldActive:function(){return 0<this.shieldCounter&&0<this.energy},radius:function(){return this.isShieldActive()?this.SHIELD_RADIUS:this.PLAYER_RADIUS},expired:function(){return!this.alive},kill:function(){this.alive=!1,this.killedOn=GameHandler.frameStart},firePrimary:function(e){var t=!1;if(this.alive&&(!this.isShieldActive()||this.fireWhenShield))for(var s in this.primaryWeapons){var i=this.primaryWeapons[s].fire();if(i){if(isArray(i))for(var r=0;r<i.length;r++)e.push(i[r]);else e.push(i);t||(GameHandler.playSound("laser"),t=!0)}}},fireSecondary:function(e){var t;this.alive&&(!this.isShieldActive()||this.fireWhenShield)&&this.energy>this.BOMB_ENERGY&&GameHandler.frameStart-this.bombRecharge>this.BOMB_RECHARGE_MS&&(this.bombRecharge=GameHandler.frameStart,this.energy-=this.BOMB_ENERGY,(t=new Vector(0,-3)).rotate(this.heading*RAD),t.add(this.vector),e.push(new Asteroids.Bomb(this.position.clone(),t)))},onUpdate:function(){!this.isShieldActive()&&this.energy<this.ENERGY_INIT&&(this.energy+=.1)},reset:function(e){this.alive=!0,e||(this.primaryWeapons=[],this.primaryWeapons.main=new Asteroids.PrimaryWeapon(this),this.fireWhenShield=!1),this.energy=this.ENERGY_INIT+this.SHIELD_MIN_PULSE,this.activateShield()}}),Asteroids.Weapon=function(e){return this.player=e,this},Asteroids.Weapon.prototype={WEAPON_RECHARGE:125,weaponRecharge:0,player:null,fire:function(){if(GameHandler.frameStart-this.weaponRecharge>this.WEAPON_RECHARGE)return this.weaponRecharge=GameHandler.frameStart,this.doFire()},doFire:function(){}},Asteroids.PrimaryWeapon=function(e){return Asteroids.PrimaryWeapon.superclass.constructor.call(this,e),this},extend(Asteroids.PrimaryWeapon,Asteroids.Weapon,{doFire:function(){var e=new Vector(0,-4.5);return e.rotate(this.player.heading*RAD),e.add(this.player.vector),new Asteroids.Bullet(this.player.position.clone(),e,this.player.heading)}}),Asteroids.TwinCannonsWeapon=function(e){return this.WEAPON_RECHARGE=150,Asteroids.TwinCannonsWeapon.superclass.constructor.call(this,e),this},extend(Asteroids.TwinCannonsWeapon,Asteroids.Weapon,{doFire:function(){var e=new Vector(0,-4.5);return e.rotate(this.player.heading*RAD),e.add(this.player.vector),new Asteroids.BulletX2(this.player.position.clone(),e,this.player.heading)}}),Asteroids.VSprayCannonsWeapon=function(e){return this.WEAPON_RECHARGE=250,Asteroids.VSprayCannonsWeapon.superclass.constructor.call(this,e),this},extend(Asteroids.VSprayCannonsWeapon,Asteroids.Weapon,{doFire:function(){var e=[],t=this.player.heading-15,s=new Vector(0,-3.75).rotate(t*RAD).add(this.player.vector);return e.push(new Asteroids.Bullet(this.player.position.clone(),s,t)),t=this.player.heading,s=new Vector(0,-3.75).rotate(t*RAD).add(this.player.vector),e.push(new Asteroids.Bullet(this.player.position.clone(),s,t)),t=this.player.heading+15,s=new Vector(0,-3.75).rotate(t*RAD).add(this.player.vector),e.push(new Asteroids.Bullet(this.player.position.clone(),s,t)),e}}),Asteroids.SideGunWeapon=function(e){return this.WEAPON_RECHARGE=250,Asteroids.SideGunWeapon.superclass.constructor.call(this,e),this},extend(Asteroids.SideGunWeapon,Asteroids.Weapon,{doFire:function(){var e=[],t=this.player.heading-90,s=new Vector(0,-4.5).rotate(t*RAD).add(this.player.vector);return e.push(new Asteroids.Bullet(this.player.position.clone(),s,t,750)),t=this.player.heading+90,s=new Vector(0,-4.5).rotate(t*RAD).add(this.player.vector),e.push(new Asteroids.Bullet(this.player.position.clone(),s,t,750)),e}}),Asteroids.RearGunWeapon=function(e){return this.WEAPON_RECHARGE=250,Asteroids.RearGunWeapon.superclass.constructor.call(this,e),this},extend(Asteroids.RearGunWeapon,Asteroids.Weapon,{doFire:function(){var e=new Vector(0,-4.5),t=this.player.heading+180;return e.rotate(t*RAD),e.add(this.player.vector),new Asteroids.Bullet(this.player.position.clone(),e,t,750)}}),Asteroids.Bullet=function(e,t,s,i){return Asteroids.Bullet.superclass.constructor.call(this,e,t),this.heading=s,i&&(this.lifespan=i),this.bulletStart=GameHandler.frameStart,this},extend(Asteroids.Bullet,Game.Actor,{BULLET_WIDTH:2,BULLET_HEIGHT:6,FADE_LENGTH:200,heading:0,lifespan:1300,bulletStart:0,powerLevel:1,onRender:function(e){40<GameHandler.frameStart-this.bulletStart&&(e.save(),BITMAPS&&(e.globalCompositeOperation="lighter"),e.globalAlpha=this.fadeValue(1,this.FADE_LENGTH),e.translate(this.position.x,this.position.y),e.rotate(this.heading*RAD),e.drawImage(GameHandler.bitmaps.images.bullet[BITMAPS?0:1],.5*-(this.BULLET_WIDTH+2*GLOWSHADOWBLUR),.5*-(this.BULLET_HEIGHT+2*GLOWSHADOWBLUR)),e.restore())},expired:function(){return GameHandler.frameStart-this.bulletStart>this.lifespan},effectRadius:function(){return 0},radius:function(){return.5*(this.BULLET_HEIGHT+this.BULLET_WIDTH)},power:function(){return this.powerLevel},fadeValue:function(e,t){var s=this.lifespan-(GameHandler.frameStart-this.bulletStart),i=e;return s<t&&((i=e/t*s)<0?i=0:e<i&&(i=e)),i}}),Asteroids.BulletX2=function(e,t,s){return Asteroids.BulletX2.superclass.constructor.call(this,e,t,s),this.lifespan=1750,this.powerLevel=2,this},extend(Asteroids.BulletX2,Asteroids.Bullet,{onRender:function(e){40<GameHandler.frameStart-this.bulletStart&&(e.save(),BITMAPS&&(e.globalCompositeOperation="lighter"),e.globalAlpha=this.fadeValue(1,this.FADE_LENGTH),e.translate(this.position.x,this.position.y),e.rotate(this.heading*RAD),e.drawImage(GameHandler.bitmaps.images.bulletx2[BITMAPS?0:1],.5*-(this.BULLET_WIDTH+4*GLOWSHADOWBLUR),.5*-(this.BULLET_HEIGHT+2*GLOWSHADOWBLUR)),e.restore())},radius:function(){return this.BULLET_HEIGHT}}),Asteroids.Bomb=function(e,t){return Asteroids.Bomb.superclass.constructor.call(this,e,t),this.lifespan=3e3,this},extend(Asteroids.Bomb,Asteroids.Bullet,{BOMB_RADIUS:4,FADE_LENGTH:200,EFFECT_RADIUS:45,onRender:function(e){e.save(),BITMAPS&&(e.globalCompositeOperation="lighter"),e.globalAlpha=this.fadeValue(1,this.FADE_LENGTH),e.translate(this.position.x,this.position.y),e.rotate(GameHandler.frameStart%11520/32);var t=this.fadeValue(1,this.FADE_LENGTH);e.scale(t=t<=0?.01:t,t),e.drawImage(GameHandler.bitmaps.images.bomb[BITMAPS?0:1],.5*-(2*this.BOMB_RADIUS+2*GLOWSHADOWBLUR),.5*-(2*this.BOMB_RADIUS+2*GLOWSHADOWBLUR)),e.restore()},effectRadius:function(){return this.EFFECT_RADIUS},radius:function(){return this.fadeValue(this.BOMB_RADIUS,this.FADE_LENGTH)}}),Asteroids.EnemyBullet=function(e,t){return Asteroids.EnemyBullet.superclass.constructor.call(this,e,t,0),this.lifespan=2800,this},extend(Asteroids.EnemyBullet,Asteroids.Bullet,{BULLET_RADIUS:4,FADE_LENGTH:200,onRender:function(e){e.save(),e.globalAlpha=this.fadeValue(1,this.FADE_LENGTH),BITMAPS&&(e.globalCompositeOperation="lighter"),e.translate(this.position.x,this.position.y),e.rotate(GameHandler.frameStart%23040/64);var t=this.fadeValue(1,this.FADE_LENGTH);e.scale(t=t<=0?.01:t,t),e.drawImage(GameHandler.bitmaps.images.enemybullet[BITMAPS?0:1],.5*-(2*this.BULLET_RADIUS+2*GLOWSHADOWBLUR),.5*-(2*this.BULLET_RADIUS+2*GLOWSHADOWBLUR)),e.restore()},radius:function(){return this.fadeValue(this.BULLET_RADIUS,this.FADE_LENGTH)+1}}),Asteroids.Asteroid=function(e,t,s,i){return Asteroids.Asteroid.superclass.constructor.call(this,e,t),this.size=s,this.health=s,void 0===i&&(i=randomInt(1,4)),this.animImage=g_asteroidImgs[i-1],this.type=i,this.animForward=Rnd()<.5,this.animSpeed=.3+.5*Rnd(),this.animLength=this.ANIMATION_LENGTH,this.rotation=randomInt(0,180),this.rotationSpeed=(Rnd()-.5)/30,this},extend(Asteroids.Asteroid,Game.EnemyActor,{ANIMATION_LENGTH:180,size:0,type:1,health:0,rotation:0,rotationSpeed:0,onRender:function(e){var t=8*this.size;e.save(),BITMAPS?this.renderSprite(e,this.position.x-t-2,this.position.y-t-2,2*t+4):(t=2*t+2*GLOWSHADOWBLUR,Game.Util.renderImageRotated(e,GameHandler.bitmaps.images.asteroid[this.type-1][this.size-1],this.position.x,this.position.y,t,t,this.rotation+=this.rotationSpeed)),e.restore()},radius:function(){return 8*this.size},hit:function(e){return-1!==e?this.health-=e:this.health=0,!(this.alive=0<this.health)}}),Asteroids.EnemyShip=function(e,t){var s;return this.size=t,1===this.size&&(this.BULLET_RECHARGE_MS=1300,this.RADIUS=8),t=e.player.position.x<GameHandler.width/2?(s=e.player.position.y<GameHandler.height/2?new Vector(GameHandler.width-48,GameHandler.height-48):new Vector(GameHandler.width-48,48),new Vector(-(Rnd()+.25+.75*t),Rnd()+.25+.75*t)):(s=e.player.position.y<GameHandler.height/2?new Vector(0,GameHandler.height-48):new Vector(0,48),new Vector(Rnd()+.25+.75*t,Rnd()+.25+.75*t)),this.animImage=g_enemyshipImg,this.animLength=this.SHIP_ANIM_LENGTH,Asteroids.EnemyShip.superclass.constructor.call(this,s,t),this},extend(Asteroids.EnemyShip,Game.EnemyActor,{SHIP_ANIM_LENGTH:90,RADIUS:16,BULLET_RECHARGE_MS:1800,alive:!0,size:0,bulletRecharge:0,onUpdate:function(e){var t,s;0===this.size?Rnd()<.01&&(this.vector.y=-(this.vector.y+(.25-Rnd()/2))):Rnd()<.02&&(this.vector.y=-(this.vector.y+(.5-Rnd()))),GameHandler.frameStart-this.bulletRecharge>this.BULLET_RECHARGE_MS&&e.player.alive&&(this.bulletRecharge=GameHandler.frameStart,s=e.player.position.clone().sub(this.position),t=(0===this.size?3:3.5)/s.length(),s.x*=t,s.y*=t,s.x+=0===this.size?2*Rnd()-1:Rnd()-.5,s.y+=0===this.size?2*Rnd()-1:Rnd()-.5,s=new Asteroids.EnemyBullet(this.position.clone(),s),e.enemyBullets.push(s),GameHandler.playSound("enemy_bomb"))},onRender:function(e){var t;BITMAPS?(t=this.RADIUS+2,this.renderSprite(e,this.position.x-t,this.position.y-t,2*t,!0)):(e.save(),e.translate(this.position.x,this.position.y),0===this.size&&(e.scale(2,2),e.lineWidth=.75),e.beginPath(),e.moveTo(0,-4),e.lineTo(8,3),e.lineTo(0,8),e.lineTo(-8,3),e.lineTo(0,-4),e.closePath(),e.shadowColor=e.strokeStyle=Asteroids.Colours.ENEMY_SHIP_DARK,e.stroke(),e.beginPath(),e.moveTo(0,-8),e.lineTo(4,-4),e.lineTo(0,0),e.lineTo(-4,-4),e.lineTo(0,-8),e.closePath(),e.shadowColor=e.strokeStyle=Asteroids.Colours.ENEMY_SHIP,e.stroke(),e.restore())},radius:function(){return this.RADIUS},hit:function(){return!(this.alive=!1)},expired:function(){return!this.alive}}),Asteroids.Particles=function(e,t,s,i){Asteroids.Particles.superclass.constructor.call(this,e,t),this.particles=new Array(s);for(var r=0;r<s;r++)this.particles[r]=i.call(this,r);return this},extend(Asteroids.Particles,Game.Actor,{particles:null,onRender:function(e){e.save(),e.shadowBlur=0,e.globalCompositeOperation="lighter";for(var t,s=0;s<this.particles.length;s++)(t=this.particles[s]).update()?(e.save(),t.render(e),e.restore()):this.particles.splice(s,1);e.restore()},expired:function(){return 0===this.particles.length}}),Asteroids.AsteroidExplosion=function(s,i,r){var e=BITMAPS?2*r.size:r.size+2;return Asteroids.AsteroidExplosion.superclass.constructor.call(this,s,i,e,function(){var e,t=s.clone();return BITMAPS?Rnd()<.5?((e=new Vector(0,randomInt(5,10))).rotate(Rnd()*TWOPI).add(i),new AsteroidsParticle(t,e,~~(4*Rnd()),0,400,300)):((e=new Vector(0,randomInt(1,3))).rotate(Rnd()*TWOPI).add(i),new AsteroidsParticle(t,e,~~(4*Rnd())+r.size,2,500,250)):((e=new Vector(0,randomInt(2,5))).rotate(Rnd()*TWOPI).add(i),new AsteroidsParticle(t,e,Rnd()*r.size+4,1,400,300,"white"))}),this},extend(Asteroids.AsteroidExplosion,Asteroids.Particles),Asteroids.PlayerExplosion=function(s,i){var e=BITMAPS?12:3;return Asteroids.PlayerExplosion.superclass.constructor.call(this,s,i,e,function(){var e,t=s.clone();return BITMAPS?Rnd()<.5?((e=new Vector(0,randomInt(5,10))).rotate(Rnd()*TWOPI).add(i),new AsteroidsParticle(t,e,~~(4*Rnd()),0,400,300)):((e=new Vector(0,randomInt(1,3))).rotate(Rnd()*TWOPI).add(i),new AsteroidsParticle(t,e,2+~~(4*Rnd()),2,500,250)):((e=new Vector(0,randomInt(2,5))).rotate(Rnd()*TWOPI).add(i),new AsteroidsParticle(t,e,6,1,400,300,"white"))}),this},extend(Asteroids.PlayerExplosion,Asteroids.Particles),Asteroids.EnemyExplosion=function(s,i,r){var e=BITMAPS?8:6;return Asteroids.EnemyExplosion.superclass.constructor.call(this,s,i,e,function(){var e,t=s.clone();return BITMAPS?Rnd()<.5?((e=new Vector(0,randomInt(5,10))).rotate(Rnd()*TWOPI).add(i),new AsteroidsParticle(t,e,~~(4*Rnd()),0,400,300,Asteroids.Colours.ENEMY_SHIP)):((e=new Vector(0,randomInt(1,3))).rotate(Rnd()*TWOPI).add(i),new AsteroidsParticle(t,e,~~(4*Rnd())+(0===r.size?2:0),2,500,250,Asteroids.Colours.ENEMY_SHIP)):((e=new Vector(0,randomInt(2,4))).rotate(Rnd()*TWOPI).add(i),new AsteroidsParticle(t,e,0===r.size?8:4,1,400,300,Asteroids.Colours.ENEMY_SHIP))}),this},extend(Asteroids.EnemyExplosion,Asteroids.Particles),Asteroids.Explosion=function(e,t,s){return Asteroids.Explosion.superclass.constructor.call(this,e,t,this.FADE_LENGTH),this.size=s,this},extend(Asteroids.Explosion,Game.EffectActor,{FADE_LENGTH:300,size:0,onRender:function(e){var t=Floor(this.effectValue(255)),s=this.effectValue(8*this.size),t=t.toString();e.save(),e.globalAlpha=.75,e.fillStyle="rgb("+t+",0,0)",e.beginPath(),e.arc(this.position.x,this.position.y,s,0,TWOPI,!0),e.closePath(),e.fill(),e.restore()}}),Asteroids.PlayerBulletImpact=function(t,s){return Asteroids.PlayerBulletImpact.superclass.constructor.call(this,t,s,5,function(){var e=s.nscale(.75+.5*Rnd());return e.rotate(Rnd()*PIO4-PIO8),new AsteroidsParticle(t.clone(),e,~~(4*Rnd()),0,250,150,Asteroids.Colours.GREEN_LASER)}),this},extend(Asteroids.PlayerBulletImpact,Asteroids.Particles),Asteroids.EnemyBulletImpact=function(t,s){return Asteroids.EnemyBulletImpact.superclass.constructor.call(this,t,s,5,function(){var e=s.nscale(.75+.5*Rnd());return e.rotate(Rnd()*PIO4-PIO8),new AsteroidsParticle(t.clone(),e,~~(4*Rnd()),0,250,150,Asteroids.Colours.ENEMY_SHIP)}),this},extend(Asteroids.EnemyBulletImpact,Asteroids.Particles),Asteroids.TextIndicator=function(e,t,s,i,r,a){return this.fadeLength=a||this.DEFAULT_FADE_LENGTH,Asteroids.TextIndicator.superclass.constructor.call(this,e,t,this.fadeLength),this.msg=s,i&&(this.textSize=i),r&&(this.colour=r),this},extend(Asteroids.TextIndicator,Game.EffectActor,{DEFAULT_FADE_LENGTH:500,fadeLength:0,textSize:12,msg:null,colour:"white",onRender:function(e){var t=this.effectValue(1);e.save(),e.globalAlpha=t,Game.fillText(e,this.msg,this.textSize+"pt Courier New",this.position.x,this.position.y,this.colour),e.restore()}}),Asteroids.ScoreIndicator=function(e,t,s,i,r,a,n){s=s.toString();return Asteroids.ScoreIndicator.superclass.constructor.call(this,e,t,s=r?r+" "+s:s,i,a,n),this},extend(Asteroids.ScoreIndicator,Asteroids.TextIndicator),Asteroids.PowerUp=function(e,t){return Asteroids.PowerUp.superclass.constructor.call(this,e,t),this},extend(Asteroids.PowerUp,Game.EffectActor,{RADIUS:8,pulse:128,pulseinc:5,onRender:function(e){e.save(),e.globalAlpha=.75;var t="rgb(255,"+this.pulse.toString()+",0)";BITMAPS?(e.fillStyle=t,e.strokeStyle="rgb(255,255,128)"):(e.lineWidth=2,e.shadowColor=e.strokeStyle=t),e.beginPath(),e.arc(this.position.x,this.position.y,this.RADIUS,0,TWOPI,!0),e.closePath(),BITMAPS&&e.fill(),e.stroke(),e.restore(),this.pulse+=this.pulseinc,255<this.pulse?(this.pulse=256-this.pulseinc,this.pulseinc=-this.pulseinc):this.pulse<0&&(this.pulse=0-this.pulseinc,this.pulseinc=-this.pulseinc)},radius:function(){return this.RADIUS},collected:function(e,t,s){var i,r=null;switch(randomInt(0,9)){case 0:case 1:r=Game.Util.message("powerup-energy-boost"),t.energy+=t.ENERGY_INIT/2,t.energy>t.ENERGY_INIT&&(t.energy=t.ENERGY_INIT);break;case 2:r=Game.Util.message("powerup-fire-shielded"),t.fireWhenShield=!0;break;case 3:r=Game.Util.message("powerup-extra-life"),e.lives++;break;case 4:for(var r=Game.Util.message("powerup-slow-asteroids"),a=0,n=s.enemies.length;a<n;a++)(l=s.enemies[a])instanceof Asteroids.Asteroid&&l.vector.scale(.66);break;case 5:r=Game.Util.message("powerup-smart-bomb");var o=new Asteroids.Explosion(this.position.clone(),this.vector.clone().scale(.5),12);s.effects.push(o);for(var l,a=0,h=this.position;a<s.enemies.length;a++)l=s.enemies[a],h.distance(l.position)<=96+l.radius()&&(l.hit(-1),s.generatePowerUp(l),s.destroyEnemy(l,this.vector,!0));break;case 6:r=Game.Util.message("powerup-twin-cannons"),t.primaryWeapons.main=new Asteroids.TwinCannonsWeapon(t);break;case 7:r=Game.Util.message("powerup-spray-cannons"),t.primaryWeapons.main=new Asteroids.VSprayCannonsWeapon(t);break;case 8:r=Game.Util.message("powerup-rear-gun"),t.primaryWeapons.rear=new Asteroids.RearGunWeapon(t);break;case 9:r=Game.Util.message("powerup-side-guns"),t.primaryWeapons.side=new Asteroids.SideGunWeapon(t)}r&&(i=new Vector(0,-1.5),i=new Asteroids.TextIndicator(new Vector(this.position.x,this.position.y-this.RADIUS),i,r,null,null,700),s.effects.push(i))}}),Asteroids.Prerenderer=function(){Asteroids.Prerenderer.superclass.constructor.call(this);function t(e,t){for(var s=[],i=3;i<=6;i++){var r=i<<1;e.width=e.height=r;var a=e.getContext("2d"),n=a.createRadialGradient(i,i,i>>1,i,i,i);n.addColorStop(0,t),n.addColorStop(1,"#000"),a.fillStyle=n,a.fillRect(0,0,r,r);r=new Image;r.src=e.toDataURL("image/png"),s.push(r)}return s}this.addRenderer(function(e){return t.call(this,e,Asteroids.Colours.PARTICLE)},"points_"+Asteroids.Colours.PARTICLE),this.addRenderer(function(e){return t.call(this,e,Asteroids.Colours.GREEN_LASER)},"points_"+Asteroids.Colours.GREEN_LASER),this.addRenderer(function(e){return t.call(this,e,Asteroids.Colours.ENEMY_SHIP)},"points_"+Asteroids.Colours.ENEMY_SHIP);function s(e,t){for(var s=[],i=4;i<=32;i+=4){var r=i<<1;e.width=e.height=r;var a=e.getContext("2d"),n=a.createRadialGradient(i,i,i>>3,i,i,i);n.addColorStop(0,t),n.addColorStop(1,"#000"),a.fillStyle=n,a.fillRect(0,0,r,r);r=new Image;r.src=e.toDataURL("image/png"),s.push(r)}return s}return this.addRenderer(function(e){return s.call(this,e,Asteroids.Colours.PARTICLE)},"smudges_"+Asteroids.Colours.PARTICLE),this.addRenderer(function(e){return s.call(this,e,Asteroids.Colours.ENEMY_SHIP)},"smudges_"+Asteroids.Colours.ENEMY_SHIP),this.addRenderer(function(e){var t=[];e.width=2+2*GLOWSHADOWBLUR,e.height=6+2*GLOWSHADOWBLUR;function s(e,t){i.beginPath(),i.moveTo(0,t),i.lineTo(e,0),i.lineTo(0,-t),i.lineTo(-e,0),i.closePath()}var i=e.getContext("2d");i.shadowBlur=GLOWSHADOWBLUR,i.translate(.5*e.width,.5*e.height),i.shadowColor=i.fillStyle=Asteroids.Colours.GREEN_LASER_DARK,s.call(this,1,5),i.fill(),i.shadowColor=i.fillStyle=Asteroids.Colours.GREEN_LASER,s.call(this,2,6),i.fill();var r=new Image;return r.src=e.toDataURL("image/png"),t.push(r),e.width=e.width,i.shadowBlur=GLOWSHADOWBLUR,i.translate(.5*e.width,.5*e.height),i.shadowColor=i.strokeStyle=Asteroids.Colours.GREEN_LASER_DARK,s.call(this,1,5),i.stroke(),i.shadowColor=i.strokeStyle=Asteroids.Colours.GREEN_LASER,s.call(this,2,6),i.stroke(),(r=new Image).src=e.toDataURL("image/png"),t.push(r),t},"bullet"),this.addRenderer(function(e){var t=[];e.width=2+4*GLOWSHADOWBLUR,e.height=6+2*GLOWSHADOWBLUR;function s(e,t){i.beginPath(),i.moveTo(0,t),i.lineTo(e,0),i.lineTo(0,-t),i.lineTo(-e,0),i.closePath()}var i=e.getContext("2d");i.shadowBlur=GLOWSHADOWBLUR,i.translate(.5*e.width,.5*e.height),i.save(),i.translate(-4,0),i.shadowColor=i.fillStyle=Asteroids.Colours.GREEN_LASERX2_DARK,s.call(this,1,5),i.fill(),i.shadowColor=i.fillStyle=Asteroids.Colours.GREEN_LASERX2,s.call(this,2,6),i.fill(),i.translate(8,0),i.shadowColor=i.fillStyle=Asteroids.Colours.GREEN_LASERX2_DARK,s.call(this,1,5),i.fill(),i.shadowColor=i.fillStyle=Asteroids.Colours.GREEN_LASERX2,s.call(this,2,6),i.fill(),i.restore();var r=new Image;return r.src=e.toDataURL("image/png"),t.push(r),e.width=e.width,i.shadowBlur=GLOWSHADOWBLUR,i.translate(.5*e.width,.5*e.height),i.save(),i.translate(-4,0),i.shadowColor=i.strokeStyle=Asteroids.Colours.GREEN_LASERX2_DARK,s.call(this,1,5),i.stroke(),i.shadowColor=i.strokeStyle=Asteroids.Colours.GREEN_LASERX2,s.call(this,2,6),i.stroke(),i.translate(8,0),i.shadowColor=i.strokeStyle=Asteroids.Colours.GREEN_LASERX2_DARK,s.call(this,1,5),i.stroke(),i.shadowColor=i.strokeStyle=Asteroids.Colours.GREEN_LASERX2,s.call(this,2,6),i.stroke(),i.restore(),(r=new Image).src=e.toDataURL("image/png"),t.push(r),t},"bulletx2"),this.addRenderer(function(e){var t=4,s=[];e.width=e.height=2*t+2*GLOWSHADOWBLUR;function i(){r.beginPath(),r.moveTo(2*t,0);for(var e=0;e<15;e++)r.rotate(PIO8),e%2==0?r.lineTo(2*t/.525731*.200811,0):r.lineTo(2*t,0);r.closePath()}var r=e.getContext("2d");r.shadowBlur=GLOWSHADOWBLUR,r.shadowColor=r.fillStyle=Asteroids.Colours.PLAYER_BOMB,r.translate(.5*e.width,.5*e.height),i.call(this),r.fill();var a=new Image;return a.src=e.toDataURL("image/png"),s.push(a),e.width=e.width,r.shadowBlur=GLOWSHADOWBLUR,r.shadowColor=r.strokeStyle=Asteroids.Colours.PLAYER_BOMB,r.lineWidth=1.5,r.translate(.5*e.width,.5*e.height),r.scale(.9,.9),i.call(this),r.stroke(),(a=new Image).src=e.toDataURL("image/png"),s.push(a),s},"bomb"),this.addRenderer(function(e){for(var t,s=[],i=1;i<=4;i++){for(var r=[],a=1;a<=4;a++){e.width=e.height=16*a+2*GLOWSHADOWBLUR;var n=e.getContext("2d");switch(n.shadowBlur=GLOWSHADOWBLUR,n.shadowColor=n.strokeStyle="white",n.translate(.5*e.width,.5*e.height),n.scale(.8*a,.8*a),n.lineWidth=.8/a*2.5,n.beginPath(),i){case 1:n.moveTo(0,10),n.lineTo(8,6),n.lineTo(10,-4),n.lineTo(4,-2),n.lineTo(6,-6),n.lineTo(0,-10),n.lineTo(-10,-3),n.lineTo(-10,5);break;case 2:n.moveTo(0,10),n.lineTo(8,6),n.lineTo(10,-4),n.lineTo(4,-2),n.lineTo(6,-6),n.lineTo(0,-10),n.lineTo(-8,-8),n.lineTo(-6,-3),n.lineTo(-8,-4),n.lineTo(-10,5);break;case 3:n.moveTo(-4,10),n.lineTo(1,8),n.lineTo(7,10),n.lineTo(10,-4),n.lineTo(4,-2),n.lineTo(6,-6),n.lineTo(0,-10),n.lineTo(-10,-3),n.lineTo(-10,5);break;case 4:n.moveTo(-8,10),n.lineTo(7,8),n.lineTo(10,-2),n.lineTo(6,-10),n.lineTo(-2,-8),n.lineTo(-6,-10),n.lineTo(-10,-6),n.lineTo(-7,0)}n.closePath(),n.stroke(),(t=new Image).src=e.toDataURL("image/png"),r.push(t)}s.push(r)}return s},"asteroid"),this.addRenderer(function(e){var t=4,s=[];e.width=e.height=2*t+2*GLOWSHADOWBLUR;function i(){r.beginPath(),r.moveTo(2*t,0);for(var e=0;e<7;e++)r.rotate(PIO4),e%2==0?r.lineTo(2*t/.525731*.200811,0):r.lineTo(2*t,0);r.closePath()}var r=e.getContext("2d");r.shadowBlur=GLOWSHADOWBLUR,r.shadowColor=r.fillStyle=Asteroids.Colours.ENEMY_SHIP,r.translate(.5*e.width,.5*e.height),r.beginPath(),r.arc(0,0,t-1,0,TWOPI,!0),r.closePath(),r.fill(),i.call(this),r.fill();var a=new Image;return a.src=e.toDataURL("image/png"),s.push(a),e.width=e.width,r.shadowBlur=GLOWSHADOWBLUR,r.shadowColor=r.strokeStyle=Asteroids.Colours.ENEMY_SHIP,r.lineWidth=1.5,r.translate(.5*e.width,.5*e.height),r.scale(.9,.9),r.beginPath(),r.arc(0,0,t-1,0,TWOPI,!0),r.closePath(),r.stroke(),i.call(this),r.stroke(),(a=new Image).src=e.toDataURL("image/png"),s.push(a),s},"enemybullet"),this},extend(Asteroids.Prerenderer,Game.Prerenderer);