var Game,iOS=-1!=navigator.userAgent.indexOf("iPhone;")||-1!=navigator.userAgent.indexOf("iPod;")||-1!=navigator.userAgent.indexOf("iPad;"),isFireFox=-1!=navigator.userAgent.indexOf(" Firefox/"),GameHandler={game:null,paused:!1,canvas:null,width:0,height:0,frameCount:0,frameMultipler:1,frameStart:0,maxfps:0,FPSMS:1e3/60,KEY:{SHIFT:16,CTRL:17,ESC:27,RIGHT:39,UP:38,LEFT:37,DOWN:40,SPACE:32,A:65,E:69,G:71,L:76,P:80,R:82,S:83,Z:90},GAMEPAD:1e3,gamepad:null,gamepadButtons:{},audioContext:null,hasAudio:function(){return null!==this.audioContext},audioComp:null,audioGain:null,sounds:{},soundEnabled:!0,init:function(){this.canvas=document.getElementById("canvas"),this.width=this.canvas.height,this.height=this.canvas.width,this.gamepad="function"==typeof navigator.getGamepads,this.audioContext="function"==typeof AudioContext?new AudioContext:null,this.audioContext&&(this.audioGain=this.audioContext.createGain(),this.audioGain.gain.value=.05,this.audioComp=this.audioContext.createDynamicsCompressor(),this.audioGain.connect(this.audioComp),this.audioComp.connect(this.audioContext.destination))},start:function(e){e instanceof Game.Main&&(this.game=e,GameHandler.frameStart=Date.now()),GameHandler.game.frame.call(GameHandler.game)},pause:function(){this.paused?(this.paused=!1,GameHandler.frameStart=Date.now(),GameHandler.game.frame.call(GameHandler.game)):this.paused=!0},loadSound:function(e,n){var t;this.hasAudio()&&(t=this).audioContext.decodeAudioData(soundUrlToArrayBuffer(e),function(e){t.sounds[n]=e})},playSound:function(e){var n;this.soundEnabled&&this.hasAudio()&&this.sounds[e]&&((n=this.audioContext.createBufferSource()).buffer=this.sounds[e],n.connect(this.audioGain),n.start(0))}};(Game=void 0===Game||!Game?{}:Game).Main=function(){var t=this;document.onkeydown=function(e){var n=e.keyCode;-1!==t.sceneIndex?t.scenes[t.sceneIndex].onKeyDownHandler(n)&&(e.preventDefault(),e.stopPropagation()):n===GameHandler.KEY.SPACE&&(e.preventDefault(),e.stopPropagation())},document.onkeyup=function(e){var n=e.keyCode;-1!==t.sceneIndex?t.scenes[t.sceneIndex].onKeyUpHandler(n)&&(e.preventDefault(),e.stopPropagation()):n===GameHandler.KEY.SPACE&&(e.preventDefault(),e.stopPropagation())},iOS&&(document.body.addEventListener("touchstart",function(e){-1!==t.sceneIndex&&t.scenes[t.sceneIndex].onTouchStartHandler(e)&&e.preventDefault()},!1),document.body.addEventListener("touchmove",function(e){-1!==t.sceneIndex&&t.scenes[t.sceneIndex].onTouchMoveHandler(e)&&e.preventDefault()},!0),document.body.addEventListener("touchend",function(e){-1!==t.sceneIndex&&t.scenes[t.sceneIndex].onTouchEndHandler(e)&&e.preventDefault()},!1),document.body.addEventListener("touchcancel",function(e){-1!==t.sceneIndex&&t.scenes[t.sceneIndex].onTouchEndHandler(e)&&e.preventDefault()},!1))},Game.Main.prototype={scenes:[],startScene:null,endScene:null,currentScene:null,sceneIndex:-1,interval:null,frame:function(){var e=Date.now();if(GameHandler.gamepad&&-1!==this.sceneIndex)for(var n,t=0;t<navigator.getGamepads().length;t++)if(n=navigator.getGamepads()[t]){for(var a=0;a<n.buttons.length;a++)n.buttons[a].pressed?(GameHandler.gamepadButtons[a]=!0,this.scenes[this.sceneIndex].onKeyDownHandler(GameHandler.GAMEPAD+a)):GameHandler.gamepadButtons[a]&&(GameHandler.gamepadButtons[a]=!1,this.scenes[this.sceneIndex].onKeyUpHandler(GameHandler.GAMEPAD+a));for(var i=0;i<n.axes.length;i++)this.scenes[this.sceneIndex].onAxisHandler(i,n.axes[i]);break}var r=this.currentScene;null===r?(this.sceneIndex=0,(r=this.scenes[0]).onInitScene()):this.isGameOver()&&(this.sceneIndex=-1,(r=this.endScene).onInitScene()),(null===r.interval||r.interval.complete)&&r.isComplete()&&(this.sceneIndex++,(r=this.sceneIndex<this.scenes.length?this.scenes[this.sceneIndex]:(this.sceneIndex=0,this.scenes[0])).onInitScene());var s=GameHandler.canvas.getContext("2d");s.save(),null===r.interval||r.interval.complete?(r.onBeforeRenderScene(),this.onRenderGame(s),r.onRenderScene(s)):(this.onRenderGame(s),r.interval.intervalRenderer.call(r,r.interval,s)),s.restore(),this.currentScene=r,GameHandler.frameCount++;r=e-GameHandler.frameStart;0===r&&(r=1),GameHandler.frameCount%16==0&&(GameHandler.maxfps=~~(1e3/r)),GameHandler.frameMultipler=r/GameHandler.FPSMS,GameHandler.frameStart=e;e=~~(GameHandler.FPSMS-(Date.now()-e));GameHandler.paused||requestAnimFrame(GameHandler.start,e)},onRenderGame:function(e){},isGameOver:function(){return!1}},Game.Scene=function(e,n){this.playable=e,this.interval=n},Game.Scene.prototype={playable:!0,interval:null,isPlayable:function(){return this.playable},onInitScene:function(){null!==this.interval&&this.interval.reset()},onBeforeRenderScene:function(){},onRenderScene:function(e){},onRenderInterval:function(e){},onKeyDownHandler:function(e){},onKeyUpHandler:function(e){},onAxisHandler:function(e,n){},onTouchStartHandler:function(e){},onTouchMoveHandler:function(e){},onTouchEndHandler:function(e){},isComplete:function(){return!1}},Game.Interval=function(e,n){this.label=e,this.intervalRenderer=n,this.framecounter=0,this.complete=!1},Game.Interval.prototype={label:null,intervalRenderer:null,framecounter:0,complete:!1,reset:function(){this.framecounter=0,this.complete=!1}},Game.Actor=function(e,n){return this.position=e,this.vector=n,this},Game.Actor.prototype={position:null,vector:null,onUpdate:function(){},onRender:function(e){},expired:function(){return!1}},Game.SpriteActor=function(e,n,t){return Game.SpriteActor.superclass.constructor.call(this,e,n),t&&(this.frameSize=t),this},extend(Game.SpriteActor,Game.Actor,{frameSize:64,animImage:null,animLength:0,animForward:!0,animSpeed:1,animFrame:0,renderSprite:function(e,n,t,a){Game.Util.renderImage(e,this.animImage,0,this.animFrame<<6,this.frameSize,n,t,a),this.animForward?(this.animFrame+=this.animSpeed*GameHandler.frameMultipler,this.animFrame>=this.animLength&&(this.animFrame=0)):(this.animFrame-=this.animSpeed*GameHandler.frameMultipler,this.animFrame<0&&(this.animFrame=this.animLength-1))}}),Game.EnemyActor=function(e,n){return this.position=e,this.vector=n,this},extend(Game.EnemyActor,Game.SpriteActor,{alive:!0,expired:function(){return!this.alive},hit:function(e){return!(this.alive=!1)}}),Game.EffectActor=function(e,n,t){return Game.EffectActor.superclass.constructor.call(this,e,n),this.lifespan=t,this.effectStart=GameHandler.frameStart,this},extend(Game.EffectActor,Game.Actor,{lifespan:0,effectStart:0,expired:function(){return GameHandler.frameStart-this.effectStart>this.lifespan},effectValue:function(e){var n=e-e/this.lifespan*(GameHandler.frameStart-this.effectStart);return n<0?n=0:e<n&&(n=e),n}}),Game.Preloader=function(){return this.images=new Array,this},Game.Preloader.prototype={images:null,callback:null,counter:0,addImage:function(e,n){var t=this;e.url=n,e.onload=function(){t.counter++,t.counter===t.images.length&&t.callback.call(t)},this.images.push(e)},onLoadCallback:function(e){this.counter=0,this.callback=e;for(var n=0,t=this.images.length;n<t;n++)this.images[n].src=this.images[n].url}},Game.drawText=function(e,n,t,a,i,r){e.save(),r&&(e.strokeStyle=r),e.font=t,e.strokeText(n,a,i),e.restore()},Game.centerDrawText=function(e,n,t,a,i){e.save(),i&&(e.strokeStyle=i),e.font=t,e.strokeText(n,(GameHandler.width-e.measureText(n).width)/2,a),e.restore()},Game.fillText=function(e,n,t,a,i,r){e.save(),r&&(e.fillStyle=r),e.font=t,e.fillText(n,a,i),e.restore()},Game.centerFillText=function(e,n,t,a,i){e.save(),i&&(e.fillStyle=i),e.font=t,e.fillText(n,(GameHandler.width-e.measureText(n).width)/2,a),e.restore()},Game.Util={},Game.Util.renderImage=function(e,n,t,a,i,r,s,o){e.drawImage(n,t,a,i,i,r,s,o,o),r<0&&e.drawImage(n,t,a,i,i,GameHandler.width+r,s,o,o),s<0&&e.drawImage(n,t,a,i,i,r,GameHandler.height+s,o,o),r<0&&s<0&&e.drawImage(n,t,a,i,i,GameHandler.width+r,GameHandler.height+s,o,o),r+o>GameHandler.width&&e.drawImage(n,t,a,i,i,r-GameHandler.width,s,o,o),s+o>GameHandler.height&&e.drawImage(n,t,a,i,i,r,s-GameHandler.height,o,o),r+o>GameHandler.width&&s+o>GameHandler.height&&e.drawImage(n,t,a,i,i,r-GameHandler.width,s-GameHandler.height,o,o)},Game.Util.renderImageRotated=function(t,a,e,n,i,r,s){function o(e,n){t.save(),t.translate(e,n),t.rotate(s),t.drawImage(a,-l,-d),t.restore()}var l=.5*i,d=.5*r;o.call(this,e,n),e-l<0&&o.call(this,GameHandler.width+e,n),n-d<0&&o.call(this,e,GameHandler.height+n),e-l<0&&n-d<0&&o.call(this,GameHandler.width+e,GameHandler.height+n),e-l+i>GameHandler.width&&o.call(this,e-GameHandler.width,n),n-d+r>GameHandler.height&&o.call(this,e,n-GameHandler.height),e-l+i>GameHandler.width&&n-d+r>GameHandler.height&&o.call(this,e-GameHandler.width,n-GameHandler.height)},Game.Util.messages={},Game.Util.message=function(e){var n=Game.Util.messages[e];return n||e},Game.Util.loadMessages=function(e){for(var n=messageUrl("messages-"+e+".txt").split("\n"),t=0;t<n.length;t++){var a=n[t].split("=");a[0]&&a[1]&&(Game.Util.messages[a[0]]=a[1])}},Game.Prerenderer=function(){return this.images=[],this._renderers=[],this},Game.Prerenderer.prototype={images:null,_renderers:null,addRenderer:function(e,n){this._renderers[n]=e},execute:function(){var e,n=document.createElement("canvas");for(e in this._renderers)this.images[e]=this._renderers[e].call(this,n)}},window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,n){window.setTimeout(e,n)};